# Полное отключение встроенных правил Make
MAKEFLAGS += --no-builtin-rules --no-builtin-variables
.SUFFIXES:

# Переменные компиляции (используем := для немедленного расширения)
CXX := g++
CXXFLAGS := -std=c++20 -Wall -Wextra
COVERAGE_FLAGS := --coverage
GTEST_LIBS := -lgtest -lgtest_main -pthread

# Исходные файлы
MAIN_SOURCES := main.cpp database.cpp
TEST_SOURCES := test.cpp database.cpp

# Исполняемые файлы
APP_TARGET := student_app
TEST_TARGET := test_runner

# PHONY цели
.PHONY: all app run-tests clean help

# Цель по умолчанию
all: app

# Справка
help:
	@echo "Доступные цели:"
	@echo "  all       - собрать основное приложение (по умолчанию)"
	@echo "  app       - собрать основное приложение"
	@echo "  run-tests - собрать и запустить тесты"
	@echo "  clean     - удалить все скомпилированные файлы"
	@echo "  help      - показать эту справку"

# Сборка основного приложения
app: $(APP_TARGET)

$(APP_TARGET): $(MAIN_SOURCES)
	$(CXX) $(CXXFLAGS) -o $@ $^

# Сборка и запуск тестов
run-tests: $(TEST_TARGET)
	./$(TEST_TARGET)

$(TEST_TARGET): $(TEST_SOURCES)
	$(CXX) $(CXXFLAGS) $(COVERAGE_FLAGS) -o $@ $^ $(GTEST_LIBS)

# Очистка
clean:
	rm -f $(APP_TARGET) $(TEST_TARGET) *.gcno *.gcda *.gcov

# Дополнительная защита от встроенных правил
%: %.cpp
	@echo "Встроенное правило заблокировано для $@"
	@false

# Блокировка конкретного встроенного правила для test
test:
	@echo "Использование встроенного правила 'test' заблокировано"
	@echo "Используйте 'make run-tests' для запуска тестов"
	@false
